#!/usr/bin/env python3

from jarvis_cd.jarvis_manager import JarvisManager
import argparse
from jarvis_cd.exception import Error,ErrorCode
from jarvis_cd.util.naming import ToCamelCase
import sys,os

def BasicArgs():
    parser = argparse.ArgumentParser(description='Jarvis CD')
    parser.add_argument("launcher", metavar='launcher', type=str,
                             help="The launcher for a program")
    parser.add_argument("operation", metavar='operation', type=str,
                             help="Operation for the launcher (e.g., start)")
    parser.add_argument("-C", dest='scaffold', metavar='directory', type=str,
                        help="The directory containing all launcher configurations")
    parser.add_argument("-I", dest='pkg_id', metavar='pkg_id', type=str,
                        help="The name of the package instance to search for")

    #Only check the first 3 params
    args = sys.argv[1:3]
    other_args = sys.argv[3:]

    #Add -C to the basic argparse if it exists
    for i, param in enumerate(other_args):
        if param == '-C':
            scaffold_dir = other_args[i+1]
            args += ['-C', scaffold_dir]
            other_args.remove('-C')
            other_args.remove(scaffold_dir)
        elif param == '-I':
            pkg_id = other_args[i+1]
            args += ['-I', pkg_id]
            other_args.remove('-I')
            other_args.remove(pkg_id)

    args = parser.parse_args(args)
    return args,other_args

if __name__ == '__main__':
    #Load the arguments
    args,other_args = BasicArgs()
    jarvis_manager = JarvisManager.GetInstance()

    #Load the Jarvis CD launcher module
    launcher_module_name = str(args.launcher)
    launcher_class_name = ToCamelCase(launcher_module_name)
    launcher_class = jarvis_manager.GetLauncherClass(launcher_module_name, launcher_class_name)
    if launcher_class is None:
        raise Error(ErrorCode.LAUNCHER_NOT_FOUND).format(launcher_module_name)

    # Load the launcher operation
    launcher_op_name = ToCamelCase(str(args.operation))
    launcher_op = getattr(launcher_class, launcher_op_name)

    #Create the launcher instance and load configuration
    scaffold_dir = args.scaffold
    pkg_id = args.pkg_id
    no_config_opts = {'Scaffold', 'Create', 'Base', 'ListConfigs'}
    if launcher_op_name not in no_config_opts:
        launcher_instance = launcher_class(scaffold_dir=scaffold_dir, pkg_id=pkg_id, load_config=True)
        if not launcher_instance.is_scaffolded:
            print(f"No configuration file found when calling {launcher_class_name}.{launcher_op_name}.")
            print("Are you cd'd into a directory that contains a jarvis_conf.yaml?")
            print("Did you provide the correct path using -C?")
            print("Did you provide a package name using -I?")
            print(f"jarvis_conf.yaml is produced after calling jarvis {launcher_class_name} scaffold or jarvis {launcher_class_name} create")
            exit(1)
    elif launcher_class_name == 'Base':
        launcher_instance = launcher_class(scaffold_dir=os.environ['JARVIS_ROOT'], load_config=True)
    else:
        launcher_instance = launcher_class(scaffold_dir=scaffold_dir, pkg_id=pkg_id, load_config=False)

    #Get the arguments for the operation
    launcher_op_args = f"_{launcher_op_name}Args"
    parser = argparse.ArgumentParser(description=f"{launcher_class_name}: {launcher_op_name}")
    parser.prog = f"{launcher_class_name}.{launcher_op_name}()"
    if hasattr(launcher_instance, launcher_op_args):
        launcher_argparse = getattr(launcher_instance, launcher_op_args)
        launcher_argparse(parser)
    launcher_args = vars(parser.parse_args(other_args))

    #Call the operation
    result = launcher_op(launcher_instance, **launcher_args)
